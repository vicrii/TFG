# üöÄ Despliegue en Railway - Plataforma Educativa

Railway es nuestra plataforma recomendada para el despliegue de la aplicaci√≥n. Esta gu√≠a te llevar√° paso a paso para tener tu aplicaci√≥n funcionando en producci√≥n.

## üéØ ¬øPor qu√© Railway?

- ‚úÖ **Deploy autom√°tico** desde GitHub
- ‚úÖ **Escalado autom√°tico** basado en demanda
- ‚úÖ **Variables de entorno** seguras
- ‚úÖ **Logs en tiempo real** para debugging
- ‚úÖ **Base de datos integrada** (PostgreSQL/MySQL)
- ‚úÖ **CDN y SSL** incluidos
- ‚úÖ **Costo efectivo** con plan gratuito

## üìã Prerrequisitos

- ‚úÖ Cuenta en [Railway](https://railway.app)
- ‚úÖ Cuenta en [GitHub](https://github.com)
- ‚úÖ Repositorio del proyecto en GitHub
- ‚úÖ MongoDB Atlas configurado
- ‚úÖ API Keys de servicios externos (OpenAI, etc.)

## üõ†Ô∏è Configuraci√≥n Paso a Paso

### **1. Preparar el Repositorio**

Asegurate de que tu proyecto tenga esta estructura:

```
plataforma-educativa/
‚îú‚îÄ‚îÄ railway.toml          # ‚úÖ Configuraci√≥n de Railway
‚îú‚îÄ‚îÄ Dockerfile.simple     # ‚úÖ Dockerfile optimizado
‚îú‚îÄ‚îÄ package.json          # ‚úÖ Scripts de build
‚îú‚îÄ‚îÄ front/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ back/
    ‚îú‚îÄ‚îÄ package.json
    ‚îî‚îÄ‚îÄ ...
```

### **2. Conectar con Railway**

1. **Crear Proyecto en Railway**
   ```bash
   # Opci√≥n 1: Desde CLI (recomendado)
   npm install -g @railway/cli
   railway login
   railway init
   
   # Opci√≥n 2: Desde la web
   # Ir a https://railway.app/new
   ```

2. **Conectar Repositorio GitHub**
   - Ir a Railway Dashboard
   - Click en "New Project"
   - Seleccionar "Deploy from GitHub repo"
   - Autorizar y seleccionar tu repositorio

### **3. Configurar Variables de Entorno**

En Railway Dashboard ‚Üí Project ‚Üí Variables:

#### **Variables Requeridas**
```env
# Base de datos
MONGODB_URI_ATLAS=mongodb+srv://user:pass@cluster.mongodb.net/plataforma-educativa

# APIs de IA (al menos una)
OPENAI_API_KEY=sk-proj-...
GOOGLE_API_KEY=AIza...

# Configuraci√≥n del servidor
NODE_ENV=production
PORT=8080

# Seguridad
JWT_SECRET=tu-secreto-super-seguro-para-produccion
CORS_ORIGIN=https://tu-dominio.railway.app

# YouTube API (opcional)
YOUTUBE_API_KEY=AIza...
```

#### **Variables Opcionales**
```env
# L√≠mites de la aplicaci√≥n
MAX_FILE_SIZE=10485760
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX=100

# Logging
LOG_LEVEL=info

# Analytics
ANALYTICS_ENABLED=true
```

### **4. Configurar railway.toml**

Archivo `railway.toml` en la ra√≠z del proyecto:

```toml
[build]
builder = "dockerfile"
dockerfilePath = "Dockerfile.simple"

[deploy]
startCommand = "node dist/server.js"
healthcheckPath = "/api/health"
healthcheckTimeout = 300
restartPolicyType = "always"
```

### **5. Optimizar Dockerfile.simple**

```dockerfile
# Multi-stage build para Railway
FROM node:20-alpine AS frontend-builder

WORKDIR /app/front
COPY front/package*.json ./
RUN npm install --legacy-peer-deps --production=false
COPY front/ ./
RUN npm run build

FROM node:20-alpine AS backend-builder

WORKDIR /app/back
COPY back/package*.json ./
RUN npm install --production=false
COPY back/ ./
RUN npm run build

# Imagen final optimizada
FROM node:20-alpine

WORKDIR /app

# Instalar solo dependencias de producci√≥n
COPY back/package*.json ./
RUN npm install --production && npm cache clean --force

# Copiar archivos construidos
COPY --from=backend-builder /app/back/dist ./dist
COPY --from=frontend-builder /app/front/dist ./public

# Crear directorios necesarios
RUN mkdir -p uploads logs

# Usuario no-root para seguridad
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001
USER nodejs

# Variables de entorno por defecto
ENV NODE_ENV=production
ENV PORT=8080

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD node -e "http.get('http://localhost:8080/api/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1))"

EXPOSE 8080

CMD ["node", "dist/server.js"]
```

### **6. Script de Deploy Autom√°tico**

Crear `deploy-railway.ps1`:

```powershell
#!/usr/bin/env pwsh

# Script de deploy autom√°tico para Railway
param(
    [string]$Message = "Deploy to Railway",
    [switch]$Force = $false
)

Write-Host "üöÄ Iniciando deploy a Railway..." -ForegroundColor Green

# 1. Verificar que estamos en la rama main
$currentBranch = git branch --show-current
if ($currentBranch -ne "main" -and -not $Force) {
    Write-Host "‚ùå Debes estar en la rama 'main' para hacer deploy" -ForegroundColor Red
    Write-Host "   Usa -Force para hacer deploy desde otra rama" -ForegroundColor Yellow
    exit 1
}

# 2. Verificar que no hay cambios sin commitear
$gitStatus = git status --porcelain
if ($gitStatus -and -not $Force) {
    Write-Host "‚ùå Hay cambios sin commitear:" -ForegroundColor Red
    git status --short
    Write-Host "   Commitea los cambios o usa -Force" -ForegroundColor Yellow
    exit 1
}

# 3. Ejecutar tests
Write-Host "üß™ Ejecutando tests..." -ForegroundColor Blue
npm test
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Tests fallaron. Deploy cancelado." -ForegroundColor Red
    exit 1
}

# 4. Build local para verificar
Write-Host "üî® Verificando build..." -ForegroundColor Blue
npm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Build fall√≥. Deploy cancelado." -ForegroundColor Red
    exit 1
}

# 5. Commit y push
Write-Host "üì§ Pushing cambios..." -ForegroundColor Blue
git add .
git commit -m $Message
git push origin main

# 6. Trigger deploy en Railway
Write-Host "üöÄ Triggeando deploy en Railway..." -ForegroundColor Blue
railway up

# 7. Verificar deploy
Start-Sleep 30
Write-Host "‚úÖ Verificando deploy..." -ForegroundColor Blue
$healthUrl = railway status --json | ConvertFrom-Json | Select-Object -ExpandProperty url
$healthUrl += "/api/health"

try {
    $response = Invoke-RestMethod -Uri $healthUrl -TimeoutSec 30
    if ($response.status -eq "ok") {
        Write-Host "‚úÖ Deploy exitoso! üéâ" -ForegroundColor Green
        Write-Host "üåê URL: $(railway status --json | ConvertFrom-Json | Select-Object -ExpandProperty url)" -ForegroundColor Cyan
    } else {
        Write-Host "‚ö†Ô∏è  Deploy completado pero health check fall√≥" -ForegroundColor Yellow
    }
} catch {
    Write-Host "‚ö†Ô∏è  No se pudo verificar el health check" -ForegroundColor Yellow
    Write-Host "   Verifica manualmente: $healthUrl" -ForegroundColor Gray
}

Write-Host "üéØ Deploy completado!" -ForegroundColor Green
```

## üîß Configuraci√≥n Avanzada

### **Base de Datos**

#### **Opci√≥n 1: MongoDB Atlas (Recomendado)**
```bash
# Ya configurado en variables de entorno
MONGODB_URI_ATLAS=mongodb+srv://...
```

#### **Opci√≥n 2: Railway PostgreSQL**
```bash
# Si prefieres PostgreSQL, Railway puede proveerlo
railway add postgresql
```

### **CDN y Archivos Est√°ticos**

Railway sirve autom√°ticamente los archivos est√°ticos del frontend. Para optimizar:

```dockerfile
# En Dockerfile.simple, asegurate de:
COPY --from=frontend-builder /app/front/dist ./public
```

### **Dominios Personalizados**

1. **Ir a Railway Dashboard**
2. **Settings ‚Üí Domains**
3. **Add Domain**
4. **Configurar DNS:**
   ```
   CNAME: tu-dominio.com ‚Üí railway-production-url
   ```

### **SSL/HTTPS**

Railway proporciona SSL autom√°ticamente:
- ‚úÖ Certificados autom√°ticos con Let's Encrypt
- ‚úÖ Renovaci√≥n autom√°tica
- ‚úÖ Redirecci√≥n HTTP ‚Üí HTTPS

## üìä Monitoreo y Logs

### **Ver Logs en Tiempo Real**
```bash
# Desde CLI
railway logs

# Desde web
# Dashboard ‚Üí Deployments ‚Üí View Logs
```

### **M√©tricas de Performance**
Railway Dashboard proporciona:
- üìà CPU y memoria usage
- üåê Requests por minuto
- ‚è±Ô∏è Response times
- üíæ Database connections

### **Alertas**
Configurar en Dashboard ‚Üí Settings ‚Üí Notifications:
- üìß Email alerts para errores
- üí¨ Slack/Discord webhooks
- üì± SMS para incidentes cr√≠ticos

## üêõ Debugging en Producci√≥n

### **Logs Detallados**
```env
# En variables de Railway
LOG_LEVEL=debug
NODE_ENV=production
```

### **Health Check Personalizado**
```javascript
// En tu backend, agregar endpoint detallado
app.get('/api/health/detailed', async (req, res) => {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    services: {
      database: 'checking...',
      ai: 'checking...',
      memory: process.memoryUsage(),
      uptime: process.uptime()
    }
  };
  
  // Check database
  try {
    await mongoose.connection.db.admin().ping();
    health.services.database = 'connected';
  } catch (err) {
    health.services.database = 'error';
    health.status = 'degraded';
  }
  
  res.json(health);
});
```

### **Error Tracking**
Integrar con servicios como Sentry:

```bash
npm install @sentry/node
```

```javascript
// En tu backend
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV
});
```

## üö® Troubleshooting

### **Build Failures**

#### **Error: Node modules no encontrados**
```bash
# Verificar que package.json est√° en la ra√≠z
# Y que railway.toml apunta al Dockerfile correcto
```

#### **Error: Frontend build falla**
```bash
# Verificar variables de entorno del frontend
VITE_API_URL=$RAILWAY_PUBLIC_DOMAIN/api
```

#### **Error: Out of memory**
```dockerfile
# Optimizar Dockerfile
RUN npm install --production
RUN npm cache clean --force
```

### **Runtime Errors**

#### **Error: Database connection**
```bash
# Verificar MONGODB_URI_ATLAS
# Verificar whitelist de IPs en MongoDB Atlas (permitir 0.0.0.0/0)
```

#### **Error: API Keys**
```bash
# Verificar que las API keys est√°n configuradas
# Y que tienen los permisos correctos
```

#### **Error: CORS**
```bash
# Actualizar CORS_ORIGIN con la URL de Railway
CORS_ORIGIN=https://tu-proyecto-production.railway.app
```

### **Performance Issues**

#### **Respuesta lenta**
```bash
# Verificar m√©tricas en Railway Dashboard
# Considerar upgrade del plan si es necesario
```

#### **Timeouts**
```env
# Aumentar timeouts
RAILWAY_HEALTHCHECK_TIMEOUT=300
```

## üí∞ Costos y Optimizaci√≥n

### **Plan Gratuito de Railway**
- ‚úÖ $5 USD de cr√©dito mensual gratis
- ‚úÖ Hasta 500 horas de compute
- ‚úÖ 1GB RAM, 1 vCPU
- ‚úÖ 1GB de storage

### **Optimizaciones para Reducir Costos**
```dockerfile
# Usar im√°genes Alpine (m√°s peque√±as)
FROM node:20-alpine

# Eliminar dev dependencies
RUN npm install --production

# Limpiar cache
RUN npm cache clean --force
```

### **Escalado Autom√°tico**
Railway escala autom√°ticamente basado en:
- üìä CPU usage
- üíæ Memory usage  
- üåê Request volume

## üîí Seguridad

### **Variables de Entorno Seguras**
- ‚úÖ Nunca commitas secrets al repositorio
- ‚úÖ Usa Railway's secret management
- ‚úÖ Rota API keys regularmente

### **Headers de Seguridad**
```javascript
// En tu backend
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
}));
```

### **Rate Limiting**
```javascript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100 // limit each IP to 100 requests per windowMs
});

app.use('/api/', limiter);
```

## üéØ Checklist de Deploy

Antes de hacer deploy, verifica:

- [ ] ‚úÖ Todas las variables de entorno configuradas
- [ ] ‚úÖ MongoDB Atlas configurado y accessible
- [ ] ‚úÖ API keys v√°lidas y con cr√©dito
- [ ] ‚úÖ Frontend build sin errores
- [ ] ‚úÖ Backend build sin errores
- [ ] ‚úÖ Tests pasando
- [ ] ‚úÖ CORS configurado correctamente
- [ ] ‚úÖ Health check funcionando
- [ ] ‚úÖ Dockerfile optimizado
- [ ] ‚úÖ railway.toml configurado

## üìû Soporte

¬øProblemas con el deploy?

- üìñ **Railway Docs**: [docs.railway.app](https://docs.railway.app)
- üí¨ **Railway Discord**: [discord.gg/railway](https://discord.gg/railway)
- üêõ **Nuestro Discord**: [discord.gg/plataforma-educativa](https://discord.gg/plataforma-educativa)
- üìß **Email**: deployment@plataforma-educativa.com

---

## üéâ ¬°Deploy Exitoso!

Si llegaste hasta aqu√≠, ¬°felicidades! Tu aplicaci√≥n deber√≠a estar funcionando en:

**üåê URL**: `https://tu-proyecto-production.railway.app`

### **Pr√≥ximos Pasos**
1. **[Configurar dominio personalizado](./custom-domain.md)**
2. **[Configurar monitoreo avanzado](./monitoring.md)**
3. **[Optimizar performance](./performance.md)**
4. **[Configurar backups](./backups.md)** 